---
title: 自动化部署项目
date: 2020-07-03
sidebar: "auto"
categories:
  - 部署
tags:
  - 部署
---

## PM2 部署 Node 项目到服务器

使用 pm2 部署 node 项目需要服务器和本地电脑都可以使用 ssh 连接到 GitHub 或者是 gitee。并且服务器也要有 Node 环境和 PM2。

### 服务器设置

1. 服务器安装 pm2

```shell
npm install pm2 -g
```

2. 设置 pm2 开机自启

```shell
pm2 startup ubuntu # 可选 Ubuntu centos redhat gentoo systemd darwin amazon
# 按照命令进行输入即可
# 最后保存设置
pm2 save
```

3. 创建密钥对连接 gitee

```shell
ssh-keygen -t rsa -C "your_email@example.com"
```

运行完上述命名后会在`~/.ssh`文件夹下创建一对文件`id_ras` `id_rsa.pub`，这一对文件就是密钥对其中`.pub`文件就是公钥，将公钥添加到 gitee 就可以使用私钥连接 gitee 了。

### 本地设置

1. 在项目根目录下新建 deploy.yaml 的配置文件

```yaml
# deploy.yaml
apps:
  - script: ./start.js # 入口文件
    name: "app" # 程序名称
    env: # 环境变量
      COMMON_VARIABLE: true
    env_production:
      NODE_ENV: production

deploy: # 部署脚本
  production: # 生产环境
    user: xxx # 服务器的用户名
    host: 192.168.0.1 # 服务器的ip地址
    port: 22 # ssh端口
    ref: origin/master # 要拉取的git分支
    ssh_options: StrictHostKeyChecking=no # SSH 公钥检查
    repo: https://github.com/**.git # 远程仓库地址
    path: /home # 拉取到服务器某个目录下
    pre-deploy: git fetch --all # 部署前执行
    post-deploy: npm install &&  pm2 reload deploy.yaml --env production # 部署后执行
    env:
      NODE_ENV: production
```

2. 使用 pm2 部署项目
   每次部署前先将本地的代码提交到远程仓库

- 首次部署

```shell
pm2 deploy deploy.yaml production setup

```

- 再次部署

```shell
pm2 deploy deploy.yaml production update

```

## GitHub-Actions 部署到服务器

1. 在项目的根目录创建.github 文件夹在此文件夹下在创建 workflows 文件夹
2. 在 workflows 文件夹下添加 node.js.yml 文件

```yml
name: Node.js CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x]

    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm install
      - run: npm run build --if-present
      - run: npm test
      - name: ssh deploy
        uses: easingthemes/ssh-deploy@v2.1.4
        with:
          # Private Key
          SSH_PRIVATE_KEY: ${{ secrets.ASUS }}
          # Remote host
          REMOTE_HOST: "188.131.188.209"
          # Remote user
          REMOTE_USER: root
          # Remote port
          # REMOTE_PORT: # optional, default is 22
          ARGS: "-rltgoDzvO --delete"
          # Source directory
          SOURCE: "dist/"
          # Target directory
          TARGET: "/home/ubuntu/docker_nginx/www/college/"
```

3. 将登录服务器的私钥上传到 GitHub 项目的 Settings -> Secrets 下
4. 以后每次修改 master 分支都会进行制动部署

## GitHub-Actions 部署 GitHub-page
